# å¹¸è¿ç¥ˆæ„¿åŠŸèƒ½å¼€å‘æ€»ç»“

## ðŸŽ¯ åŠŸèƒ½æ¦‚è¿°

æ–°å¼€å‘çš„å¹¸è¿ç¥ˆæ„¿åŠŸèƒ½æ˜¯ä¸€ä¸ªç±»ä¼¼æŠ½å¡/æ¦‚çŽ‡æ¸¸æˆçš„ç³»ç»Ÿï¼Œè®©ç”¨æˆ·é€šè¿‡æ¶ˆè´¹ç”µå¸æ¥ç¥ˆæ„¿èŽ·å¾—ç¨€æœ‰å¥–åŠ±"æ·±æµ·æ­Œå§¬"ã€‚

## ðŸ“Š æ ¸å¿ƒå‚æ•°

- **ç¥ˆæ„¿ä»·æ ¼**: 500ç”µå¸/æ¬¡
- **æˆåŠŸçŽ‡**: 1.4% 
- **ä¿åº•æœºåˆ¶**: 147æ¬¡å¤±è´¥åŽç¬¬148æ¬¡å¿…å‡º
- **å¥–åŠ±**: æ·±æµ·æ­Œå§¬ (ä»·å€¼30000ç”µå¸)

## ðŸ—ï¸ æ•°æ®åº“è®¾è®¡

### 1. ç¥ˆæ„¿ç»“æžœè¡¨ (wish_results)
```sql
- id: ä¸»é”®
- username: ç”¨æˆ·å
- cost: ç¥ˆæ„¿èŠ±è´¹ (å›ºå®š500)
- success: æ˜¯å¦æˆåŠŸ (boolean)
- reward: å¥–åŠ±åç§°
- reward_value: å¥–åŠ±ä»·å€¼
- balance_before/after: ç¥ˆæ„¿å‰åŽä½™é¢
- wishes_count: å½“å‰æ˜¯ç¬¬å‡ æ¬¡ç¥ˆæ„¿
- is_guaranteed: æ˜¯å¦ä¿åº•å‡ºè´§
- game_details: æ¸¸æˆè¯¦æƒ…(JSON)
- created_at: åˆ›å»ºæ—¶é—´
```

### 2. ç¥ˆæ„¿è¿›åº¦è¡¨ (wish_progress) 
```sql
- username: ç”¨æˆ·å (å”¯ä¸€)
- total_wishes: æ€»ç¥ˆæ„¿æ¬¡æ•°
- consecutive_fails: è¿žç»­å¤±è´¥æ¬¡æ•°
- last_success_at: æœ€åŽæˆåŠŸæ—¶é—´
- total_spent: æ€»èŠ±è´¹
- total_rewards_value: æ€»å¥–åŠ±ä»·å€¼
- created_at/updated_at: æ—¶é—´æˆ³
```

## ðŸ”Œ APIæŽ¥å£

### 1. POST `/api/wish/play` - æ‰§è¡Œç¥ˆæ„¿
**è¯·æ±‚**: æ— éœ€å‚æ•° (ä»ŽsessionèŽ·å–ç”¨æˆ·)
**å“åº”**:
```json
{
  "success": true,
  "wishSuccess": false,
  "reward": null,
  "rewardValue": 0,
  "newBalance": 4500,
  "progress": {
    "total_wishes": 1,
    "consecutive_fails": 1,
    "progress_percentage": "0.7",
    "wishes_until_guarantee": 147
  },
  "isGuaranteed": false
}
```

### 2. GET `/api/wish/progress` - èŽ·å–ç¥ˆæ„¿è¿›åº¦
**å“åº”**:
```json
{
  "success": true,
  "progress": {
    "total_wishes": 10,
    "consecutive_fails": 10,
    "total_spent": 5000,
    "total_rewards_value": 0,
    "progress_percentage": "6.8",
    "wishes_until_guarantee": 138,
    "next_is_guaranteed": false
  }
}
```

### 3. GET `/api/wish/history` - èŽ·å–ç¥ˆæ„¿åŽ†å²
æ”¯æŒåˆ†é¡µï¼Œè¿”å›žç¥ˆæ„¿è®°å½•åˆ—è¡¨

## ðŸŽ® å‰ç«¯åŠŸèƒ½

### 1. ç¥ˆæ„¿ç•Œé¢æ›´æ–°
- æ˜¾ç¤º"æ·±æµ·æ­Œå§¬ 30000ç”µå¸"ç›®æ ‡
- è¿›åº¦æ¡æ˜¾ç¤ºä¿åº•è¿›åº¦ (0/148)
- å³å°†ä¿åº•æ—¶è¿›åº¦æ¡å˜ä¸ºé‡‘è‰²

### 2. ç¥ˆæ„¿æŒ‰é’®
- å•æ¬¡ç¥ˆæ„¿: 500ç”µå¸
- ä¿ç•™äº†åŽŸæœ‰çš„å¤šæ¬¡ç¥ˆæ„¿æŒ‰é’® (å¯é€‰æ‹©ä¿ç•™æˆ–åˆ é™¤)

### 3. ç»“æžœå±•ç¤º
- æˆåŠŸ: æ˜¾ç¤ºèŽ·å¾—çš„å¥–åŠ±å’Œä»·å€¼
- å¤±è´¥: é¼“åŠ±ç»§ç»­å°è¯•
- ä¿åº•æˆåŠŸæ—¶ç‰¹åˆ«æ ‡æ³¨"ä¿åº•å‡ºè´§"

## ðŸ”§ æ ¸å¿ƒé€»è¾‘

### 1. ç¥ˆæ„¿æˆåŠŸåˆ¤å®š
```javascript
const isGuaranteed = consecutive_fails >= 147;
const randomSuccess = Math.random() < 0.014; // 1.4%
const success = isGuaranteed || randomSuccess;
```

### 2. è¿›åº¦æ›´æ–°
- æˆåŠŸæ—¶: `consecutive_fails = 0`
- å¤±è´¥æ—¶: `consecutive_fails += 1`
- è®°å½•æ€»ç¥ˆæ„¿æ¬¡æ•°å’ŒèŠ±è´¹

### 3. ä½™é¢å¤„ç†
- ä½¿ç”¨ BalanceLogger ç¡®ä¿èµ„é‡‘å®‰å…¨
- å…ˆæ‰£é™¤500ç”µå¸
- æˆåŠŸæ—¶å‘æ”¾30000ç”µå¸å¥–åŠ±

## ðŸ“ ç›¸å…³æ–‡ä»¶

### åŽç«¯æ–‡ä»¶
- `server.js`: æ·»åŠ äº†ç¥ˆæ„¿APIæŽ¥å£ (2527è¡Œ-2763è¡Œ)
- `migrations/create_wish_tables.sql`: æ•°æ®åº“è¡¨åˆ›å»ºè„šæœ¬
- `setup-wish-tables.js`: æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### å‰ç«¯æ–‡ä»¶  
- `views/wish.ejs`: ç¥ˆæ„¿é¡µé¢æ›´æ–°
  - æ–°å¢žæ·±æµ·æ­Œå§¬å±•ç¤º
  - æ›´æ–°è¿›åº¦æ¡é€»è¾‘
  - é‡å†™JavaScript APIè°ƒç”¨

## ðŸš€ éƒ¨ç½²æ­¥éª¤

1. **åˆ›å»ºæ•°æ®åº“è¡¨**:
   ```bash
   node setup-wish-tables.js
   ```

2. **é‡å¯æœåŠ¡å™¨**:
   ```bash
   npm restart
   ```

3. **æµ‹è¯•åŠŸèƒ½**:
   - è®¿é—® `/wish` é¡µé¢
   - ç¡®ä¿æœ‰è¶³å¤Ÿç”µå¸ä½™é¢ (500+)
   - ç‚¹å‡»ç¥ˆæ„¿æŒ‰é’®æµ‹è¯•

## âœ… åŠŸèƒ½ç‰¹ç‚¹

1. **ç®€åŒ–è®¾è®¡**: åˆ é™¤äº†å¤æ‚çš„æ¦‚çŽ‡æŽ§åˆ¶ï¼Œåªæœ‰å›ºå®š1.4%æˆåŠŸçŽ‡
2. **ä¿åº•æœºåˆ¶**: ç¡®ä¿ç”¨æˆ·æœ€å¤šèŠ±è´¹74500ç”µå¸ (148Ã—500) å¿…å®šèŽ·å¾—30000ç”µå¸å¥–åŠ±
3. **å®Œæ•´è®°å½•**: ä¿å­˜æ¯æ¬¡ç¥ˆæ„¿çš„è¯¦ç»†è®°å½•
4. **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„è¿›åº¦æ˜¾ç¤ºå’Œç»“æžœåé¦ˆ
5. **èµ„é‡‘å®‰å…¨**: ä½¿ç”¨çŽ°æœ‰çš„ä½™é¢ç³»ç»Ÿå’Œæ—¥å¿—è®°å½•

## ðŸŽ‰ å¼€å‘å®Œæˆ

å¹¸è¿ç¥ˆæ„¿åŠŸèƒ½å·²å®Œå…¨å¼€å‘å®Œæˆï¼ŒåŒ…æ‹¬:
- âœ… æ•°æ®åº“è¡¨è®¾è®¡å’Œåˆ›å»º
- âœ… åŽç«¯APIæŽ¥å£å¼€å‘  
- âœ… å‰ç«¯é¡µé¢æ›´æ–°
- âœ… 1.4%æˆåŠŸçŽ‡å’Œä¿åº•æœºåˆ¶
- âœ… å®Œæ•´çš„ç¥ˆæ„¿è®°å½•ç³»ç»Ÿ
- âœ… æ·±æµ·æ­Œå§¬å¥–åŠ±å±•ç¤º

åŠŸèƒ½å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼