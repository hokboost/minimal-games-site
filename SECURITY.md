# 安全功能使用说明

## 🔐 功能概述

本系统实现了全面的安全防护机制，包括：
- **单设备登录** - 一个账号同时只能在一个设备登录
- **IP风控管理** - 智能IP风险评估和自动防护
- **IP黑白名单** - 精确的IP访问控制
- **登录安全** - 完整的登录日志和风险监控
- **会话管理** - 安全的会话生命周期管理

## 🚨 自动风控机制

### IP风险评分规则
| 行为 | 风险分增加 | 触发条件 |
|------|------------|----------|
| 异常高频访问 | +30 | 1小时内超过100次请求 |
| 高频访问 | +15 | 1小时内超过50次请求 |
| 多账号登录 | +25 | 1小时内超过5个不同账号 |
| 异常登录失败 | +40 | 30分钟内超过10次失败 |
| 多次登录失败 | +20 | 30分钟内超过5次失败 |
| 异地登录 | +30 | 检测到新国家/地区登录 |
| 黑名单IP | 100 | 直接最高风险 |
| 白名单IP | 0 | 直接无风险 |

### 风险等级处理
- **SAFE (0-19分)**: 正常访问
- **LOW (20-39分)**: 正常访问，记录日志
- **MEDIUM (40-59分)**: 需要额外验证，可能触发验证码
- **HIGH (60-79分)**: 需要强化验证，限制部分功能
- **CRITICAL (80-100分)**: 直接阻断访问

## 🛡️ 单设备登录机制

### 工作原理
1. 用户登录时，系统自动终止该账号的所有其他活跃会话
2. 被踢出的设备会话立即失效，需要重新登录
3. 每个账号同时只能有一个有效会话

### 会话管理
- **自动清理**: 24小时未活动的会话自动过期
- **强制注销**: 管理员可强制注销指定用户的所有会话
- **异常检测**: 检测到异常时可自动终止相关会话

## 🔧 管理员功能

### IP管理API

#### 查询IP风险信息
```bash
GET /api/admin/ip/{ip}
```

#### 添加IP到黑名单
```bash
POST /api/admin/ip/blacklist
{
  "ip": "192.168.1.100",
  "reason": "恶意攻击"
}
```

#### 添加IP到白名单
```bash
POST /api/admin/ip/whitelist
{
  "ip": "192.168.1.200", 
  "reason": "可信办公IP"
}
```

#### 移除IP黑名单
```bash
POST /api/admin/ip/remove-blacklist
{
  "ip": "192.168.1.100"
}
```

### 会话管理API

#### 强制踢出用户
```bash
POST /api/admin/force-logout
{
  "username": "target_user"
}
```

#### 获取活跃会话列表
```bash
GET /api/admin/sessions
```

#### 获取安全事件
```bash
GET /api/admin/security-events
```

## 📊 数据库表结构

### ip_activities - IP活动记录
记录所有IP的访问活动，用于风险分析

### ip_blacklist - IP黑名单
存储被封禁的IP地址

### ip_whitelist - IP白名单  
存储可信任的IP地址

### active_sessions - 活跃会话
管理用户的登录会话

### login_logs - 登录日志
记录所有登录尝试和结果

### security_events - 安全事件
记录所有安全相关事件

## ⚠️ 重要提醒

1. **管理员权限**: 所有IP管理功能需要管理员权限
2. **数据备份**: 定期备份安全日志数据
3. **监控告警**: 建议配置高风险事件告警
4. **性能影响**: IP风控会增加请求处理时间，但影响很小
5. **缓存机制**: IP风险评估有10分钟缓存，减少数据库查询

## 🔍 故障排查

### 常见问题

**Q: 用户反映被频繁踢出？**
A: 检查是否有多人共用同一账号，或者账号被盗用

**Q: 正常用户被误判为高风险？**
A: 将其IP添加到白名单，或检查风险评估规则

**Q: 系统性能下降？**
A: 检查IP活动记录表大小，定期清理历史数据

**Q: 会话验证失败？**
A: 检查数据库连接和active_sessions表状态

### 监控指标
- 活跃会话数量
- 高风险IP数量  
- 登录失败率
- 安全事件频率
- 数据库查询性能

## 📝 使用建议

1. **定期审查**: 每周检查安全事件和IP黑名单
2. **用户教育**: 告知用户单设备登录政策
3. **白名单维护**: 及时添加办公网络到白名单
4. **日志分析**: 定期分析登录模式，发现异常
5. **应急响应**: 制定高风险事件处理流程