<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketé€šçŸ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 10px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .notification { margin: 10px 0; padding: 10px; background: #e3f2fd; }
        .alert { margin: 10px 0; padding: 10px; background: #fff3e0; }
    </style>
</head>
<body>
    <h1>WebSocketé€šçŸ¥æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h3>è¿æ¥çŠ¶æ€</h3>
        <div id="connection-status">æœªè¿æ¥</div>
        <button onclick="connectWebSocket()">è¿æ¥WebSocket</button>
        <button onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
    </div>

    <div class="test-section">
        <h3>ç”¨æˆ·æ³¨å†Œ</h3>
        <input type="text" id="username" placeholder="è¾“å…¥ç”¨æˆ·å" value="è€å…­">
        <button onclick="registerUser()">æ³¨å†Œç”¨æˆ·</button>
    </div>

    <div class="test-section">
        <h3>æ¨¡æ‹Ÿé€šçŸ¥</h3>
        <button onclick="sendTestNotification()">å‘é€æµ‹è¯•é€šçŸ¥</button>
        <button onclick="sendTestSecurityAlert()">å‘é€å®‰å…¨è­¦å‘Š</button>
    </div>

    <div class="test-section">
        <h3>æ¶ˆæ¯æ—¥å¿—</h3>
        <div id="message-log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="test-section">
        <h3>é€šçŸ¥æ˜¾ç¤ºåŒº</h3>
        <div id="notification-area"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let currentUser = '';

        function log(message) {
            const logDiv = document.getElementById('message-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="log">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function connectWebSocket() {
            if (socket) {
                socket.disconnect();
            }

            socket = io();
            
            socket.on('connect', () => {
                document.getElementById('connection-status').textContent = `å·²è¿æ¥ (${socket.id})`;
                log('ğŸ”— WebSocketè¿æ¥æˆåŠŸ: ' + socket.id);
            });

            socket.on('disconnect', () => {
                document.getElementById('connection-status').textContent = 'å·²æ–­å¼€';
                log('âŒ WebSocketè¿æ¥æ–­å¼€');
            });

            socket.on('connect_error', (error) => {
                log('ğŸš¨ WebSocketè¿æ¥å¤±è´¥: ' + error.message);
            });

            socket.on('notification', (notification) => {
                log('ğŸ“¨ æ”¶åˆ°é€šçŸ¥: ' + JSON.stringify(notification));
                showNotification(notification);
            });

            socket.on('security-alert', (event) => {
                log('ğŸš¨ æ”¶åˆ°å®‰å…¨è­¦å‘Š: ' + JSON.stringify(event));
                showSecurityAlert(event);
            });
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
            }
        }

        function registerUser() {
            currentUser = document.getElementById('username').value;
            if (socket && currentUser) {
                socket.emit('register', currentUser);
                log('ğŸ‘¤ æ³¨å†Œç”¨æˆ·: ' + currentUser);
            } else {
                alert('è¯·å…ˆè¿æ¥WebSocketå¹¶è¾“å…¥ç”¨æˆ·å');
            }
        }

        function sendTestNotification() {
            if (!currentUser) {
                alert('è¯·å…ˆæ³¨å†Œç”¨æˆ·');
                return;
            }

            // æ¨¡æ‹Ÿå‘é€HTTPè¯·æ±‚æ¥è§¦å‘é€šçŸ¥
            fetch('/api/test/notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: currentUser,
                    type: 'test_notification'
                })
            }).then(response => {
                log('ğŸ“¤ å‘é€æµ‹è¯•é€šçŸ¥è¯·æ±‚');
            }).catch(error => {
                log('âŒ å‘é€å¤±è´¥: ' + error.message);
            });
        }

        function sendTestSecurityAlert() {
            if (!currentUser) {
                alert('è¯·å…ˆæ³¨å†Œç”¨æˆ·');
                return;
            }

            // ç›´æ¥æ¨¡æ‹Ÿå®‰å…¨è­¦å‘Š
            const testEvent = {
                type: 'device_logout',
                title: 'æµ‹è¯•å®‰å…¨è­¦å‘Š',
                message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•çš„è®¾å¤‡ç™»å½•é€šçŸ¥',
                level: 'warning',
                details: {
                    kickedDevices: 1,
                    timestamp: new Date().toISOString()
                }
            };

            showSecurityAlert(testEvent);
            log('ğŸ§ª æ˜¾ç¤ºæµ‹è¯•å®‰å…¨è­¦å‘Š');
        }

        function showNotification(notification) {
            const area = document.getElementById('notification-area');
            const div = document.createElement('div');
            div.className = 'notification';
            div.innerHTML = `
                <strong>${notification.title || 'é€šçŸ¥'}</strong><br>
                ${notification.message}<br>
                <small>ç±»å‹: ${notification.type}</small>
            `;
            area.appendChild(div);
        }

        function showSecurityAlert(event) {
            const area = document.getElementById('notification-area');
            const div = document.createElement('div');
            div.className = 'alert';
            div.innerHTML = `
                <strong>âš ï¸ ${event.title}</strong><br>
                ${event.message}<br>
                <small>ç­‰çº§: ${event.level}</small>
                ${event.details ? `<br><small>è®¾å¤‡æ•°: ${event.details.kickedDevices}</small>` : ''}
            `;
            area.appendChild(div);
        }

        function clearLog() {
            document.getElementById('message-log').innerHTML = '';
            document.getElementById('notification-area').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.onload = function() {
            connectWebSocket();
        };
    </script>
</body>
</html>