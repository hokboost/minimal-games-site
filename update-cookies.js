const fs = require('fs');
const path = require('path');

// æ‚¨æä¾›çš„æœ€æ–°cookieæ•°æ®
const newSessdata = '4282cb5c%2C1783283626%2C3f494%2A12CjAsqfXC9Or3IjeZY1e07RgiRh8zzrFdyhCDCDjv_0NrId9jxzc3gjf5yGXv-37oj2wSVkV3SXBRLTQyckF5dElWRk9oSlNuRGR4V3JERWVCNmRCeWgxWFYzV2cwVU1VMUdOOHZhcXFnYzRGWElvZFRvdjBsc0dESlVMSDVLS3Q5TzhrcHdOLUlnIIEC';
const newBiliJct = '141eeb64e472d403d2a8031b87613894';

const cookiePath = '/mnt/c/Users/user/Desktop/jiaobenbili/cookie.txt';

function updateCookies() {
    try {
        console.log('ğŸ”„ å¼€å§‹æ›´æ–°Bç«™cookie...');
        
        // å¤‡ä»½åŸæœ‰cookieæ–‡ä»¶
        if (fs.existsSync(cookiePath)) {
            const backupPath = `${cookiePath}.backup.${Date.now()}`;
            fs.copyFileSync(cookiePath, backupPath);
            console.log(`ğŸ“‹ åŸcookieæ–‡ä»¶å·²å¤‡ä»½åˆ°: ${backupPath}`);
        }

        // å½“å‰æ—¶é—´æˆ³ (è¿‡æœŸæ—¶é—´è®¾ç½®ä¸ºå¾ˆä¹…ä»¥å)
        const expireTime = Math.floor(Date.now() / 1000) + (365 * 24 * 60 * 60); // 1å¹´åè¿‡æœŸ

        // ç”Ÿæˆæ–°çš„cookieæ–‡ä»¶å†…å®¹ (Netscapeæ ¼å¼)
        const cookieLines = [
            '# Netscape HTTP Cookie File',
            '# Generated by Cookie Update Script',
            `# ${new Date().toISOString()}`,
            '',
            // åŸºæœ¬åŸŸåcookie
            `.bilibili.com	TRUE	/	FALSE	${expireTime}	SESSDATA	${newSessdata}`,
            `.bilibili.com	TRUE	/	FALSE	${expireTime}	bili_jct	${newBiliJct}`,
            
            // è¡¥å……å…¶ä»–å¿…è¦çš„cookie
            `.bilibili.com	TRUE	/	FALSE	${expireTime}	buvid3	XY1234567890`,
            `.bilibili.com	TRUE	/	FALSE	${expireTime}	b_nut	${Math.floor(Date.now() / 1000)}`,
            `.bilibili.com	TRUE	/	FALSE	${expireTime}	DedeUserID	123456789`,
            `.bilibili.com	TRUE	/	FALSE	${expireTime}	DedeUserID__ckMd5	abcdef1234567890`,
            `.bilibili.com	TRUE	/	FALSE	${expireTime}	sid	abcd1234`,
            
            // live.bilibili.com åŸŸå
            `.live.bilibili.com	TRUE	/	FALSE	${expireTime}	SESSDATA	${newSessdata}`,
            `.live.bilibili.com	TRUE	/	FALSE	${expireTime}	bili_jct	${newBiliJct}`,
            
            // passport.bilibili.com åŸŸå
            `.passport.bilibili.com	TRUE	/	FALSE	${expireTime}	SESSDATA	${newSessdata}`,
            `.passport.bilibili.com	TRUE	/	FALSE	${expireTime}	bili_jct	${newBiliJct}`,
            
            // api.bilibili.com åŸŸå
            `.api.bilibili.com	TRUE	/	FALSE	${expireTime}	SESSDATA	${newSessdata}`,
            `.api.bilibili.com	TRUE	/	FALSE	${expireTime}	bili_jct	${newBiliJct}`
        ];

        // å†™å…¥æ–°çš„cookieæ–‡ä»¶
        fs.writeFileSync(cookiePath, cookieLines.join('\n'));
        
        console.log('âœ… Cookieæ›´æ–°æˆåŠŸï¼');
        console.log(`ğŸ“ æ–‡ä»¶ä½ç½®: ${cookiePath}`);
        console.log(`ğŸ”‘ SESSDATA: ${newSessdata.substring(0, 20)}...`);
        console.log(`ğŸ”‘ bili_jct: ${newBiliJct}`);
        console.log(`â° è¿‡æœŸæ—¶é—´: ${new Date(expireTime * 1000).toLocaleString('zh-CN')}`);
        
        // éªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®å†™å…¥
        if (fs.existsSync(cookiePath)) {
            const fileSize = fs.statSync(cookiePath).size;
            console.log(`ğŸ“Š æ–‡ä»¶å¤§å°: ${fileSize} å­—èŠ‚`);
            
            // è¯»å–å¹¶éªŒè¯å†…å®¹
            const content = fs.readFileSync(cookiePath, 'utf-8');
            if (content.includes(newSessdata) && content.includes(newBiliJct)) {
                console.log('âœ… éªŒè¯æˆåŠŸï¼Œå…³é”®cookieå·²æ­£ç¡®å†™å…¥');
            } else {
                console.log('âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶å†™å…¥å¯èƒ½æœ‰é—®é¢˜');
            }
        }
        
    } catch (error) {
        console.error('âŒ æ›´æ–°cookieå¤±è´¥:', error);
        return false;
    }
    
    return true;
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬
if (require.main === module) {
    const success = updateCookies();
    if (success) {
        console.log('\nğŸ‰ Cookieæ›´æ–°å®Œæˆï¼æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨Bç«™é€ç¤¼åŠŸèƒ½äº†ã€‚');
    } else {
        console.log('\nğŸ’¥ Cookieæ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ã€‚');
        process.exit(1);
    }
}

module.exports = { updateCookies, newSessdata, newBiliJct };