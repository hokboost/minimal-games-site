<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KingBoost åˆ®åˆ®ä¹</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
    .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        color: #fff;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #00c853;
    }

    .header h1 {
        margin: 0;
        color: #00c853;
    }

    .nav-links {
        display: flex;
        gap: 1rem;
        align-items: center;
        color: #ccc;
    }

    .nav-links a {
        color: #fff;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .nav-links a:hover {
        background: rgba(0, 200, 83, 0.2);
        transform: translateY(-2px);
    }

    .board {
        max-width: 750px;
        margin: auto;
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 16px;
        padding: 1.5rem;
        position: relative;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
        
        .labels {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        #scratchContainer {
            position: relative;
            width: 100%;
            aspect-ratio: 5 / 4;
            background: #eee;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4);
        }
        
        #scratchCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        #scratchContent {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            font-weight: bold;
            font-size: 0.9rem;
            color: #000;
            gap: 1px;
        }
        
        .grid-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.1);
            background: #fff;
            padding: 2px;
            min-height: 40px;
        }
        
        .grid-item div:first-child {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        
        .grid-item div:last-child {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }
        
        .winning-number {
            background: #fff3cd !important;
            border-color: #ffc107 !important;
        }
        
        .winning-number div:first-child {
            color: #856404 !important;
        }
        
        .winning-number div:last-child {
            color: #f57c00 !important;
            font-weight: bold !important;
        }
        
        .scratch-ui {
            margin-top: 1.5rem;
            position: relative;
            z-index: 10;
        }
        
        button {
            padding: 0.8rem 1.5rem;
            background: #ffcc00;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #ffd700;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        #verifyResult {
            margin-top: 1rem;
        }
        
        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .board {
                max-width: 100%;
                margin: 10px;
                padding: 1rem;
            }
            
            .game-container {
                padding: 10px;
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
            }
            
            .game-container h2 {
                font-size: 1.5rem;
                margin-bottom: 10px;
            }
            
            .labels {
                font-size: 1rem;
                margin-bottom: 0.8rem;
            }
            
            #scratchContainer {
                margin: 15px 0;
            }
            
            .grid-item {
                font-size: 0.7rem;
                padding: 4px 2px;
                min-height: 35px;
            }
            
            .grid-item div:first-child {
                font-size: 0.9rem;
            }
            
            .grid-item div:last-child {
                font-size: 0.7rem;
            }
            
            .scratch-ui {
                margin-top: 1rem;
            }
            
            button {
                padding: 0.6rem 1rem;
                font-size: 14px;
                margin: 0.3rem;
            }
            
            #verifyResult {
                font-size: 1rem;
                margin-top: 0.8rem;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŸï¸ KingBoost åˆ®åˆ®ä¹</h1>
            <div class="nav-links">
                <span>ç”¨æˆ·ï¼š<%= username %></span>
                <a href="/">ğŸ  è¿”å›é¦–é¡µ</a>
                <a href="/profile">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</a>
            </div>
        </div>
        
        <div class="board">
            <h2>ğŸ¯ KingBoost åˆ®åˆ®ä¹</h2>
            <div class="labels">å…±æœ‰20æ¬¡ä¸­å¥–æœºä¼šå“¦ï¼Œå¤šä¸­å¤šå¾—ï¼ï¼ˆå¥–å“ä¸æ¶‰åŠçœŸå®é’±è´¢ï¼‰</div>
            <div id="scratchContainer">
                <div id="scratchContent"></div>
                <canvas id="scratchCanvas"></canvas>
            </div>

            <div class="scratch-ui">
                <button onclick="startScratch()">å¼€å§‹åˆ®å¥–</button>
                <button onclick="verifyWin()">ğŸ¯ ç‚¹å‡»éªŒè¯ä¸­å¥–</button>
                <p id="verifyResult" style="font-weight: bold; font-size: 1.2rem;"></p>
            </div>
        </div>
        
        <div style="
            max-width: 760px;
            margin: 2rem auto 0;
            padding: 1rem;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #ccc;
            line-height: 1.5;
            text-align: center;
        ">
            âš ï¸ <strong>Disclaimer:</strong> This scratch card feature is provided solely for entertainment purposes. It does not involve gambling, betting, or the use of any real currency. No monetary prizes are offered or can be won. Participation is entirely free, and this feature complies with Canadian laws. By using this feature, you acknowledge that it is not a game of chance and is not subject to gambling regulations.
        </div>
    </div>

    <script>
    // Polyfill for crypto.randomUUID
    if (!crypto.randomUUID) {
        crypto.randomUUID = function () {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        };
    }
    
    let hasVerified = true;
        
    function createCard(num, prize) {
        const cell = document.createElement('div');
        cell.className = 'grid-item';
        cell.innerHTML = `<div>${num}</div><div>${prize || ''}</div>`;
        return cell;
    }
        
    async function startScratch() {
        if (!hasVerified) {
            alert('è¯·å…ˆéªŒè¯å½“å‰ç»“æœåå†è¿›è¡Œä¸‹ä¸€æ¬¡åˆ®å¥–å“¦ï¼');
            return;
        }
        hasVerified = false;

        // æå‰åˆå§‹åŒ– canvas é®ç½©ï¼Œé˜²æ­¢å·ç é—ªç°
        const canvas = document.getElementById('scratchCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        const image = new Image();
        image.src = '/assets/images/chiikawa1.png';
        image.onload = () => {
            ctx.globalAlpha = 1.0;
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'destination-out';
        };
        
        // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é®ç½©
        image.onerror = () => {
            ctx.fillStyle = '#c0c0c0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'destination-out';
        };

        // å†å»è¯·æ±‚æ•°æ®
        const username = "<%= username %>";
        const timestamp = Math.floor(Date.now() / 1000);
        const nonce = crypto.randomUUID();

        const res = await fetch('https://scratch-server-vmit.onrender.com/scratch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, timestamp, nonce })
        });

        const data = await res.json();
        if (!data.success) return alert('âŒ ' + data.message);

        const all = [
            ...data.winningNumbers.map(n => ({ num: n, prize: 'ä¸­å¥–å·ç ' })),
            ...data.slots
        ];

        const container = document.getElementById('scratchContent');
        container.innerHTML = '';
        all.forEach(({ num, prize }) => container.appendChild(createCard(num, prize)));
                
        // åˆ®åˆ®é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
        let isDrawing = false, lastX = null, lastY = null;

        // é¼ æ ‡äº‹ä»¶
        canvas.onmousedown = () => {
            isDrawing = true;
        };

        canvas.onmouseup = canvas.onmouseleave = () => {
            isDrawing = false;
            lastX = lastY = null;
        };

        canvas.onmousemove = e => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            drawAt(x, y);
        };

        // è§¦æ‘¸äº‹ä»¶ï¼ˆæ‰‹æœºï¼‰
        canvas.ontouchstart = e => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
            drawAt(lastX, lastY);
        };

        canvas.ontouchmove = e => {
            if (!isDrawing) return;
            e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            drawAt(x, y);
        };

        canvas.ontouchend = () => {
            isDrawing = false;
            lastX = lastY = null;
        };

        // æŠ½å‡ºé€šç”¨ç»˜åˆ¶å‡½æ•°
        function drawAt(x, y) {
            if (lastX !== null && lastY !== null) {
                const dx = x - lastX;
                const dy = y - lastY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const steps = Math.ceil(dist / 4);
                for (let i = 0; i <= steps; i++) {
                    const lerpX = lastX + (dx * i / steps);
                    const lerpY = lastY + (dy * i / steps);
                    ctx.beginPath();
                    ctx.arc(lerpX, lerpY, 20, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            lastX = x;
            lastY = y;
        }

        document.getElementById('verifyResult').textContent = '';
    }
        
    function verifyWin() {
        const grid = Array.from(document.querySelectorAll('#scratchContent .grid-item'));
        const winNums = grid.slice(0, 5).map(cell => parseInt(cell.children[0].textContent));
        const userSlots = grid.slice(5);

        const matched = [];

        userSlots.forEach(cell => {
            const num = parseInt(cell.children[0].textContent);
            const prize = cell.children[1].textContent;
            if (winNums.includes(num)) {
                matched.push({ num, prize });
            }
        });

        const result = document.getElementById('verifyResult');
        if (matched.length > 0) {
            const msg = matched.map(m => `å·ç  ${m.num}ï¼š${m.prize}`).join('ï¼Œ ');
            result.textContent = `ğŸ‰ æ­å–œï¼Œä½ å‘½ä¸­äº† ${matched.length} ä¸ªå¥–é¡¹ï¼${msg}`;
            result.style.color = '#00ff88';
        } else {
            result.textContent = 'ğŸ˜¢ å¾ˆé—æ†¾ï¼Œæœªä¸­å¥–ï¼Œå†è¯•ä¸€æ¬¡å§ï¼';
            result.style.color = '#ff5555';
        }

        hasVerified = true;
    }
    </script>
</body>
</html>