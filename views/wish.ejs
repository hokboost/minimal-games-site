<!DOCTYPE html>
<html lang="<%= lang === 'zh' ? 'zh-CN' : 'en' %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= lang === 'zh' ? 'å¹¸è¿ç¥ˆæ„¿' : 'Lucky Wish' %></title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            color: #fff;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #00c853;
        }

        .header h1 {
            margin: 0;
            color: #00c853;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
            color: #ccc;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(0, 200, 83, 0.2);
            transform: translateY(-2px);
        }

        .wish-container {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .balance-wish-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .balance-info {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .balance-info h3 {
            color: #ffeb3b;
            margin: 0;
        }

        .gift-progress {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            height: 28px;
            position: relative;
        }

        .gift-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            transition: width 0.3s ease;
            border-radius: 10px 0 0 10px;
        }

        .gift-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: bold;
            font-size: 12px;
        }

        .wish-button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            color: white;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .wish-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(0,0,0,0.2);
        }

        .wish-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }


        .probability-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ccc;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .probability-button:hover {
            background: rgba(0, 200, 83, 0.2);
            color: #fff;
        }

        /* å…¨å±å¼¹çª—æ ·å¼ */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
        }

        .modal-content {
            text-align: center;
            color: white;
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
            animation: pulse 2s infinite;
        }

        .modal-success {
            color: #00ff00;
            text-shadow: 0 0 30px #00ff00;
        }

        .modal-failure {
            color: #ff0000;
            text-shadow: 0 0 30px #ff0000;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* é£˜å±æ ·å¼ */
        .danmaku-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 8888;
            overflow: hidden;
        }

        .danmaku-message {
            position: absolute;
            white-space: nowrap;
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, rgba(255,215,0,0.2), rgba(255,165,0,0.2));
            border: 2px solid rgba(255,215,0,0.6);
            padding: 8px 16px;
            border-radius: 20px;
            animation: danmaku-slide 12s linear;
            pointer-events: none;
            backdrop-filter: blur(2px);
        }


        @keyframes danmaku-slide {
            0% {
                transform: translateX(100vw);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(-200px);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-content {
                font-size: 2.5rem;
            }
            
            .wish-button {
                padding: 10px 16px;
                font-size: 12px;
                min-width: auto;
                flex: 1;
                max-width: 130px;
            }

            .danmaku-message {
                font-size: 14px;
                padding: 6px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .wish-button {
                padding: 8px 12px;
                font-size: 11px;
                max-width: 110px;
            }
        }

        .wish-gift-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }

        .gift-card {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 1.5rem;
            text-align: left;
        }

        .gift-card-large {
            grid-column: span 2;
            border: 2px solid rgba(0, 200, 83, 0.4);
            background: rgba(0, 200, 83, 0.08);
        }

        .gift-title {
            font-size: 1.4rem;
            color: #fff;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .gift-meta {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
        }

        .gift-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .gift-action-btn {
            background: linear-gradient(135deg, #00c853, #00bfa5);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gift-action-btn.secondary {
            background: linear-gradient(135deg, #1e88e5, #1565c0);
        }

        .gift-action-btn.test {
            background: linear-gradient(135deg, #8e44ad, #2c3e50);
        }

        .gift-action-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .wish-gift-grid {
                grid-template-columns: 1fr;
            }

            .gift-card-large {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body data-csrf-token="<%= csrfToken %>" data-can-test="<%= canWishTest ? 'true' : 'false' %>">
    <%- include('partials/language-switcher') %>

    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ <%= lang === 'zh' ? 'å¹¸è¿ç¥ˆæ„¿' : 'Lucky Wish' %></h1>
            <div class="nav-links">
                <span><%= lang === 'zh' ? 'ç”¨æˆ·' : 'User' %>ï¼š<%= username %></span>
                <a href="/">ğŸ  <%= lang === 'zh' ? 'è¿”å›é¦–é¡µ' : 'Home' %></a>
                <a href="/profile">ğŸ‘¤ <%= lang === 'zh' ? 'ä¸ªäººä¸­å¿ƒ' : 'Profile' %></a>
            </div>
        </div>

        <div class="balance-wish-section">
            <div class="balance-info">
                <h3>âš¡ <%= lang === 'zh' ? 'å½“å‰ç”µå¸' : 'Current Coins' %>: <span id="current-balance"><%= balance || 0 %></span> <%= lang === 'zh' ? 'ç”µå¸' : 'coins' %></h3>
            </div>
            <div class="wish-container">
                <p style="color: #ccc;">
                    <%= lang === 'zh'
                        ? 'è¯·é€‰æ‹©ç¤¼ç‰©æ¡£ä½è¿›è¡Œç¥ˆæ„¿ï¼ŒæˆåŠŸåç¤¼ç‰©è¿›å…¥èƒŒåŒ…ã€‚'
                        : 'Select a gift tier to make a wish. Successful gifts will enter your backpack.'
                    %>
                </p>
            </div>
        </div>
        
        <div class="wish-container">
            <div class="wish-gift-grid">
                <div class="gift-card gift-card-large" data-gift="deepsea_singer">
                    <div class="gift-title">ğŸ§œâ€â™€ï¸ <%= lang === 'zh' ? 'æ·±æµ·æ­Œå§¬' : 'Deep Sea Diva' %></div>
                    <div class="gift-meta"><%= lang === 'zh' ? 'ä»·å€¼ 30000 ç”µå¸ Â· 500 ç”µå¸/æ¬¡' : 'Value 30000 coins Â· 500 coins/draw' %></div>
                    <div class="gift-actions">
                        <button class="gift-action-btn" data-gift="deepsea_singer" data-count="1"><%= lang === 'zh' ? 'æŠ½ä¸€æ¬¡' : 'Draw Once' %></button>
                        <button class="gift-action-btn secondary" data-gift="deepsea_singer" data-count="10"><%= lang === 'zh' ? 'åè¿' : '10x Draw' %></button>
                        <button class="gift-action-btn test admin-test-btn" data-gift="deepsea_singer" style="display: none;"><%= lang === 'zh' ? '10ä¸‡æ¬¡æµ‹è¯•' : '100k Test' %></button>
                    </div>
                    <div class="gift-progress">
                        <div class="gift-progress-bar" data-progress-bar="deepsea_singer"></div>
                        <div class="gift-progress-text" data-progress-text="deepsea_singer">0 / 148</div>
                    </div>
                </div>

                <div class="gift-card" data-gift="sky_throne">
                    <div class="gift-title">ğŸ’º <%= lang === 'zh' ? 'é£å¤©è½¬æ¤…' : 'Sky Throne' %></div>
                    <div class="gift-meta"><%= lang === 'zh' ? 'ä»·å€¼ 10000 ç”µå¸ Â· 250 ç”µå¸/æ¬¡' : 'Value 10000 coins Â· 250 coins/draw' %></div>
                    <div class="gift-actions">
                        <button class="gift-action-btn" data-gift="sky_throne" data-count="1"><%= lang === 'zh' ? 'æŠ½ä¸€æ¬¡' : 'Draw Once' %></button>
                        <button class="gift-action-btn secondary" data-gift="sky_throne" data-count="10"><%= lang === 'zh' ? 'åè¿' : '10x Draw' %></button>
                        <button class="gift-action-btn test admin-test-btn" data-gift="sky_throne" style="display: none;"><%= lang === 'zh' ? '10ä¸‡æ¬¡æµ‹è¯•' : '100k Test' %></button>
                    </div>
                    <div class="gift-progress">
                        <div class="gift-progress-bar" data-progress-bar="sky_throne"></div>
                        <div class="gift-progress-text" data-progress-text="sky_throne">0 / 83</div>
                    </div>
                </div>

                <div class="gift-card" data-gift="proposal">
                    <div class="gift-title">ğŸ’ <%= lang === 'zh' ? 'åŸåœ°æ±‚å©š' : 'On-the-Spot Proposal' %></div>
                    <div class="gift-meta"><%= lang === 'zh' ? 'ä»·å€¼ 5200 ç”µå¸ Â· 208 ç”µå¸/æ¬¡' : 'Value 5200 coins Â· 208 coins/draw' %></div>
                    <div class="gift-actions">
                        <button class="gift-action-btn" data-gift="proposal" data-count="1"><%= lang === 'zh' ? 'æŠ½ä¸€æ¬¡' : 'Draw Once' %></button>
                        <button class="gift-action-btn secondary" data-gift="proposal" data-count="10"><%= lang === 'zh' ? 'åè¿' : '10x Draw' %></button>
                        <button class="gift-action-btn test admin-test-btn" data-gift="proposal" style="display: none;"><%= lang === 'zh' ? '10ä¸‡æ¬¡æµ‹è¯•' : '100k Test' %></button>
                    </div>
                    <div class="gift-progress">
                        <div class="gift-progress-bar" data-progress-bar="proposal"></div>
                        <div class="gift-progress-text" data-progress-text="proposal">0 / 52</div>
                    </div>
                </div>

                <div class="gift-card" data-gift="wonderland">
                    <div class="gift-title">ğŸŒ™ <%= lang === 'zh' ? 'æ¢¦æ¸¸ä»™å¢ƒ' : 'Wonderland Dream' %></div>
                    <div class="gift-meta"><%= lang === 'zh' ? 'ä»·å€¼ 3000 ç”µå¸ Â· 150 ç”µå¸/æ¬¡' : 'Value 3000 coins Â· 150 coins/draw' %></div>
                    <div class="gift-actions">
                        <button class="gift-action-btn" data-gift="wonderland" data-count="1"><%= lang === 'zh' ? 'æŠ½ä¸€æ¬¡' : 'Draw Once' %></button>
                        <button class="gift-action-btn secondary" data-gift="wonderland" data-count="10"><%= lang === 'zh' ? 'åè¿' : '10x Draw' %></button>
                        <button class="gift-action-btn test admin-test-btn" data-gift="wonderland" style="display: none;"><%= lang === 'zh' ? '10ä¸‡æ¬¡æµ‹è¯•' : '100k Test' %></button>
                    </div>
                    <div class="gift-progress">
                        <div class="gift-progress-bar" data-progress-bar="wonderland"></div>
                        <div class="gift-progress-text" data-progress-text="wonderland">0 / 41</div>
                    </div>
                </div>

                <div class="gift-card" data-gift="white_bride">
                    <div class="gift-title">ğŸ¤ <%= lang === 'zh' ? 'çº¯ç™½èŠ±å«' : 'Pure White Bride' %></div>
                    <div class="gift-meta"><%= lang === 'zh' ? 'ä»·å€¼ 1314 ç”µå¸ Â· 75 ç”µå¸/æ¬¡' : 'Value 1314 coins Â· 75 coins/draw' %></div>
                    <div class="gift-actions">
                        <button class="gift-action-btn" data-gift="white_bride" data-count="1"><%= lang === 'zh' ? 'æŠ½ä¸€æ¬¡' : 'Draw Once' %></button>
                        <button class="gift-action-btn secondary" data-gift="white_bride" data-count="10"><%= lang === 'zh' ? 'åè¿' : '10x Draw' %></button>
                        <button class="gift-action-btn test admin-test-btn" data-gift="white_bride" style="display: none;"><%= lang === 'zh' ? '10ä¸‡æ¬¡æµ‹è¯•' : '100k Test' %></button>
                    </div>
                    <div class="gift-progress">
                        <div class="gift-progress-bar" data-progress-bar="white_bride"></div>
                        <div class="gift-progress-text" data-progress-text="white_bride">0 / 34</div>
                    </div>
                </div>

                <div class="gift-card" data-gift="crystal_ball">
                    <div class="gift-title">ğŸ”® <%= lang === 'zh' ? 'æ°´æ™¶çƒ' : 'Crystal Ball' %></div>
                    <div class="gift-meta"><%= lang === 'zh' ? 'ä»·å€¼ 1000 ç”µå¸ Â· 66 ç”µå¸/æ¬¡' : 'Value 1000 coins Â· 66 coins/draw' %></div>
                    <div class="gift-actions">
                        <button class="gift-action-btn" data-gift="crystal_ball" data-count="1"><%= lang === 'zh' ? 'æŠ½ä¸€æ¬¡' : 'Draw Once' %></button>
                        <button class="gift-action-btn secondary" data-gift="crystal_ball" data-count="10"><%= lang === 'zh' ? 'åè¿' : '10x Draw' %></button>
                        <button class="gift-action-btn test admin-test-btn" data-gift="crystal_ball" style="display: none;"><%= lang === 'zh' ? '10ä¸‡æ¬¡æµ‹è¯•' : '100k Test' %></button>
                    </div>
                    <div class="gift-progress">
                        <div class="gift-progress-bar" data-progress-bar="crystal_ball"></div>
                        <div class="gift-progress-text" data-progress-text="crystal_ball">0 / 32</div>
                    </div>
                </div>

                <div class="gift-card" data-gift="bobo">
                    <div class="gift-title">ğŸ«§ <%= lang === 'zh' ? 'å•µå•µ' : 'Bubbles' %></div>
                    <div class="gift-meta"><%= lang === 'zh' ? 'ä»·å€¼ 399 ç”µå¸ Â· 50 ç”µå¸/æ¬¡' : 'Value 399 coins Â· 50 coins/draw' %></div>
                    <div class="gift-actions">
                        <button class="gift-action-btn" data-gift="bobo" data-count="1"><%= lang === 'zh' ? 'æŠ½ä¸€æ¬¡' : 'Draw Once' %></button>
                        <button class="gift-action-btn secondary" data-gift="bobo" data-count="10"><%= lang === 'zh' ? 'åè¿' : '10x Draw' %></button>
                        <button class="gift-action-btn test admin-test-btn" data-gift="bobo" style="display: none;"><%= lang === 'zh' ? '10ä¸‡æ¬¡æµ‹è¯•' : '100k Test' %></button>
                    </div>
                    <div class="gift-progress">
                        <div class="gift-progress-bar" data-progress-bar="bobo"></div>
                        <div class="gift-progress-text" data-progress-text="bobo">0 / 16</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 1rem 0;">
                <button class="probability-button" id="open-probability">
                    <%= lang === 'zh' ? 'æ¦‚ç‡å…¬ç¤º' : 'Odds Disclosure' %>
                </button>
            </div>


            <div style="
                max-width: 760px;
                margin: 2rem auto 0;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                font-size: 0.85rem;
                color: #ccc;
                line-height: 1.5;
                text-align: center;
            ">
                <% if (lang === 'zh') { %>
                    âš ï¸ <strong>å…è´£å£°æ˜ï¼š</strong>æœ¬è®¸æ„¿åŠŸèƒ½ä»…ä¾›å¨±ä¹æ¶ˆé£ï¼Œç¥ˆæ„¿ç»“æœä¸ºéšæœºå¨±ä¹å†…å®¹ï¼Œä¸æ¶‰åŠä»»ä½•è¿·ä¿¡æˆ–è¶…è‡ªç„¶å› ç´ ã€‚å¹³å°å†…æ‰€æœ‰ç§¯åˆ†ã€è¿›åº¦å‡ä¸ºè™šæ‹Ÿå¨±ä¹é“å…·ï¼Œæ— æ³•å…‘æ¢çœŸå®è´§å¸æˆ–æœ‰ä»·ç‰©å“ã€‚å‚ä¸å®Œå…¨å…è´¹ï¼Œç¬¦åˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚ä¸¥ç¦æœªæ»¡18å‘¨å²ç”¨æˆ·ä½¿ç”¨ï¼Œè¯·ç†æ€§å¨±ä¹ã€‚
                <% } else { %>
                    âš ï¸ <strong>Disclaimer:</strong> This wishing feature is for entertainment only. Wish results are random entertainment content and do not involve any superstition or supernatural factors. All points and progress on the platform are virtual entertainment items that cannot be exchanged for real money or valuable goods. Participation is completely free and complies with relevant laws. Strictly prohibited for users under 18 years old. Please enjoy responsibly.
                <% } %>
            </div>
        </div>
    </div>

    
    <div id="danmaku-container" class="danmaku-container"></div>

    
    <div id="fullscreenModal" class="fullscreen-modal">
        <div id="modalContent" class="modal-content"></div>
    </div>

    
    <div id="probabilityModal" class="fullscreen-modal">
        <div class="modal-content" style="font-size: 1.2rem; max-width: 680px;">
            <div style="font-size: 1.6rem; margin-bottom: 1rem;">
                ğŸ“¢ <%= lang === 'zh' ? 'æ¦‚ç‡å…¬ç¤º' : 'Odds Disclosure' %>
            </div>
            <div id="probabilityList" style="text-align: left;"></div>
            <div style="margin-top: 1rem;">
                <button class="probability-button" id="close-probability">
                    <%= lang === 'zh' ? 'å…³é—­' : 'Close' %>
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/security-alerts.js"></script>
    <script src="/js/wish.js"></script>
</body>
</html>
