<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="admin-header">
            <h1>ğŸ‘‘ ç®¡ç†åå°</h1>
            <div class="nav-links">
                <span>æ¬¢è¿ï¼Œ<%= user.username %></span>
                <a href="/">ğŸ  é¦–é¡µ</a>
                <a href="/logout">ğŸšª é€€å‡ºç™»å½•</a>
            </div>
        </div>

        <div class="admin-content">
            <!-- Bç«™Cookieç®¡ç†åŒºåŸŸ -->
            <div class="cookie-management" style="
                background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 193, 7, 0.05));
                border: 2px solid #ff9800; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem;
            ">
                <h2 style="color: #ff9800; margin-bottom: 1rem;">ğŸª Bç«™Cookieç®¡ç†</h2>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div id="cookieStatus" style="
                        padding: 0.8rem 1.2rem; border-radius: 8px; font-weight: bold;
                        background: rgba(158, 158, 158, 0.2); color: #9e9e9e;
                    ">çŠ¶æ€æ£€æŸ¥ä¸­...</div>
                    
                    <button onclick="checkCookieStatus()" style="
                        padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #2196f3, #1976d2);
                        color: white; border: none; border-radius: 8px; font-weight: bold;
                        cursor: pointer; transition: all 0.3s ease;
                    ">ğŸ” æ£€æŸ¥çŠ¶æ€</button>
                    
                    <button onclick="refreshCookies()" style="
                        padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #ff9800, #f57c00);
                        color: white; border: none; border-radius: 8px; font-weight: bold;
                        cursor: pointer; transition: all 0.3s ease;
                    ">ğŸ”„ åˆ·æ–°Cookie</button>
                </div>
                <div id="cookieDetails" style="margin-top: 1rem; font-size: 0.9rem; color: #ccc;"></div>
            </div>

            <!-- ç›´æ’­é—´ç®¡ç†åŒºåŸŸ -->
            <div class="room-management" style="
                background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(129, 199, 132, 0.05));
                border: 2px solid #4caf50; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem;
            ">
                <h2 style="color: #4caf50; margin-bottom: 1rem;">ğŸ“º ç›´æ’­é—´ç»‘å®šç®¡ç†</h2>
                
                <!-- ç»‘å®šæ“ä½œåŒºåŸŸ -->
                <div style="
                    background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 1rem; margin-bottom: 1rem;
                ">
                    <h3 style="color: #4caf50; margin-bottom: 0.8rem; font-size: 1.1rem;">â• ç»‘å®šæ–°æˆ¿é—´</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.3rem; color: #4caf50; font-size: 0.9rem;">ç”¨æˆ·å:</label>
                            <input type="text" id="bindUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å (ä¾‹: å°§é¡ºå®‡)"
                                style="
                                    width: 100%; padding: 0.8rem; border: 1px solid #555;
                                    border-radius: 8px; background: rgba(255,255,255,0.1);
                                    color: white; font-size: 1rem;
                                "
                            />
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.3rem; color: #4caf50; font-size: 0.9rem;">ç›´æ’­é—´å·:</label>
                            <input type="text" id="bindRoomId" placeholder="Bç«™ç›´æ’­é—´å· (ä¾‹: 3929738)"
                                style="
                                    width: 100%; padding: 0.8rem; border: 1px solid #555;
                                    border-radius: 8px; background: rgba(255,255,255,0.1);
                                    color: white; font-size: 1rem;
                                "
                            />
                        </div>
                        <button onclick="bindUserRoom()" style="
                            padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #4caf50, #45a049);
                            color: white; border: none; border-radius: 8px; font-weight: bold;
                            cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
                        ">ğŸ”— ç»‘å®šæˆ¿é—´</button>
                    </div>
                </div>

                <!-- è§£ç»‘æ“ä½œåŒºåŸŸ -->
                <div style="
                    background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 1rem; margin-bottom: 1rem;
                ">
                    <h3 style="color: #f44336; margin-bottom: 0.8rem; font-size: 1.1rem;">â– è§£é™¤ç»‘å®š</h3>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.3rem; color: #f44336; font-size: 0.9rem;">ç”¨æˆ·å:</label>
                            <input type="text" id="unbindUsername" placeholder="è¯·è¾“å…¥è¦è§£ç»‘çš„ç”¨æˆ·å"
                                style="
                                    width: 100%; padding: 0.8rem; border: 1px solid #555;
                                    border-radius: 8px; background: rgba(255,255,255,0.1);
                                    color: white; font-size: 1rem;
                                "
                            />
                        </div>
                        <button onclick="unbindUserRoom()" style="
                            padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #f44336, #d32f2f);
                            color: white; border: none; border-radius: 8px; font-weight: bold;
                            cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
                        ">ğŸ”“ è§£é™¤ç»‘å®š</button>
                    </div>
                </div>

                <!-- å½“å‰ç»‘å®šåˆ—è¡¨ -->
                <div>
                    <h3 style="color: #4caf50; margin-bottom: 0.8rem; font-size: 1.1rem;">ğŸ“‹ å½“å‰ç»‘å®šåˆ—è¡¨</h3>
                    <div id="currentBindings" style="
                        background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem;
                        min-height: 100px; color: #ccc;
                    ">
                        <div style="text-align: center; color: #999;">æ­£åœ¨åŠ è½½ç»‘å®šä¿¡æ¯...</div>
                    </div>
                    <button onclick="loadRoomBindings()" style="
                        margin-top: 0.8rem; padding: 0.6rem 1.2rem; 
                        background: linear-gradient(135deg, #2196f3, #1976d2);
                        color: white; border: none; border-radius: 6px; font-weight: bold;
                        cursor: pointer; transition: all 0.3s ease;
                    ">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>
            </div>

            <table class="users-table">
                <thead>
                    <tr>
                        <th>ç”¨æˆ·å</th>
                        <th>ç”µå¸ä½™é¢</th>
                        <th>æœ€æ–° Quiz</th>
                        <th>æœ€æ–° Slot</th>
                        <th>æœ€æ–° Spin</th>
                        <th>æœ€æ–° Scratch</th>
                        <th>æ“ä½œ</th>
                        <th>å¯†ç ç®¡ç†</th>
                        <th>è´¦å·ç®¡ç†</th>
                        <th>ç™»å½•çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody>
                    <% users.forEach(user => { %>
                        <tr>
                            <td><%= user.username %></td>
                            <td class="balance">
                                <span class="balance-display">âš¡<%= user.balance || 0 %> ç”µå¸</span>
                                <button class="edit-balance-btn" onclick="editBalance('<%= user.username %>', <%= user.balance || 0 %>)">
                                    âœï¸ ä¿®æ”¹
                                </button>
                            </td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>
                                <button onclick="addElectricCoin('<%= user.username %>', this)" class="btn-add">âš¡ åŠ ç”µå¸</button>
                                <% if (user.authorized) { %>
                                    <button onclick="unauthorizeUser('<%= user.username %>', this)" class="btn-unauthorize">âŒ å–æ¶ˆæˆæƒ</button>
                                <% } else { %>
                                    <button onclick="authorizeUser('<%= user.username %>', this)" class="btn-authorize">âœ… æˆæƒ</button>
                                <% } %>
                            </td>
                            <td>
                                <% if (user.username === userLoggedIn) { %>
                                    <button onclick="changeSelfPassword()" class="btn-self">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
                                <% } else { %>
                                    <button onclick="resetPassword('<%= user.username %>', this)" class="btn-reset">ğŸ”‘ é‡ç½®å¯†ç </button>
                                <% } %>
                            </td>
                            <td>
                                <% if (user.username === userLoggedIn) { %>
                                    <span class="self-indicator">ğŸ‘¤ è‡ªå·±</span>
                                <% } else { %>
                                    <button onclick="deleteAccount('<%= user.username %>', this)" class="btn-delete">ğŸ—‘ï¸ æ³¨é”€è´¦å·</button>
                                <% } %>
                            </td>
                            <td>
                                <% if (user.is_admin) { %>
                                    <span class="status-admin">ğŸ‘‘ ç®¡ç†å‘˜</span>
                                <% } else if (user.is_locked) { %>
                                    <div class="status-locked">
                                        ğŸ”’ å·²é”å®š<br>
                                        <small>å‰©ä½™ <%= user.lock_minutes %> åˆ†é’Ÿ</small><br>
                                        <small>å¤±è´¥æ¬¡æ•°: <%= user.login_failures %></small><br>
                                        <button onclick="unlockAccount('<%= user.username %>', this)" class="btn-unlock">è§£é”</button>
                                    </div>
                                <% } else if (user.login_failures > 0) { %>
                                    <div class="status-warning">
                                        âš ï¸ è­¦å‘Š<br>
                                        <small>å¤±è´¥æ¬¡æ•°: <%= user.login_failures %></small><br>
                                        <button onclick="clearFailures('<%= user.username %>', this)" class="btn-clear">æ¸…é™¤</button>
                                    </div>
                                <% } else { %>
                                    <span class="status-normal">âœ… æ­£å¸¸</span>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <style>
    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        color: #fff;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #00c853;
    }

    .admin-header h1 {
        margin: 0;
        color: #00c853;
    }

    .nav-links {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .nav-links span {
        color: #ccc;
        font-weight: bold;
    }

    .nav-links a {
        color: #fff;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .nav-links a:hover {
        background: rgba(0, 200, 83, 0.2);
        transform: translateY(-2px);
    }

    .admin-content {
        overflow-x: auto;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        overflow: hidden;
    }

    .users-table th {
        background: linear-gradient(135deg, #00c853, #00bfa5);
        color: #fff;
        padding: 1rem 0.5rem;
        text-align: left;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .users-table td {
        padding: 1rem 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        vertical-align: top;
    }

    .users-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .spins {
        color: #e91e63;
        font-weight: bold;
        font-size: 1.1rem;
    }

    /* æŒ‰é’®æ ·å¼ */
    .users-table button {
        padding: 0.3rem 0.6rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        margin: 0.1rem;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .btn-add {
        background: #4caf50;
        color: white;
    }

    .btn-add:hover {
        background: #45a049;
        transform: translateY(-1px);
    }

    .btn-authorize {
        background: #2196f3;
        color: white;
    }

    .btn-authorize:hover {
        background: #1976d2;
        transform: translateY(-1px);
    }

    .btn-unauthorize {
        background: #ff9800;
        color: white;
    }

    .btn-unauthorize:hover {
        background: #f57c00;
        transform: translateY(-1px);
    }

    .btn-reset {
        background: #ff6b6b;
        color: white;
    }

    .btn-reset:hover {
        background: #ff5252;
        transform: translateY(-1px);
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-delete:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .balance {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .balance-display {
        font-weight: bold;
        color: #4caf50;
        min-width: 60px;
    }

    .edit-balance-btn {
        background: #ff9800;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .edit-balance-btn:hover {
        background: #f57c00;
        transform: translateY(-1px);
    }

    .btn-unlock {
        background: #ffc107;
        color: #000;
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        margin-top: 0.2rem;
    }

    .btn-unlock:hover {
        background: #ffb300;
    }

    .btn-clear {
        background: #17a2b8;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        margin-top: 0.2rem;
    }

    .btn-clear:hover {
        background: #138496;
    }

    .btn-disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #666;
        color: #ccc;
    }

    .btn-self {
        background: #17a2b8;
        color: white;
    }

    .btn-self:hover {
        background: #138496;
        transform: translateY(-1px);
    }

    .self-indicator {
        color: #17a2b8;
        font-weight: bold;
        font-style: italic;
    }

    /* çŠ¶æ€æ ·å¼ */
    .status-admin {
        color: #28a745;
        font-weight: bold;
    }

    .status-locked {
        color: #dc3545;
        font-weight: bold;
        font-size: 0.8rem;
        line-height: 1.2;
    }

    .status-warning {
        color: #ffc107;
        font-weight: bold;
        font-size: 0.8rem;
        line-height: 1.2;
    }

    .status-normal {
        color: #28a745;
    }

    @media (max-width: 1200px) {
        .users-table {
            font-size: 0.8rem;
        }
        
        .users-table th,
        .users-table td {
            padding: 0.5rem 0.3rem;
        }
        
        .users-table button {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }
        
        .admin-header {
            flex-direction: column;
            gap: 1rem;
        }
        
        .users-table {
            font-size: 0.7rem;
        }
    }
    </style>

    <script>
    function addElectricCoin(username, btn) {
        const amount = prompt(`ä¸ºç”¨æˆ· "${username}" æ·»åŠ ç”µå¸:\\n\\nè¯·è¾“å…¥è¦æ·»åŠ çš„ç”µå¸æ•°é‡:`, '100');
        
        if (amount === null) return; // ç”¨æˆ·å–æ¶ˆ
        
        const coinAmount = parseFloat(amount);
        
        if (isNaN(coinAmount)) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—é‡‘é¢ï¼');
            return;
        }
        
        if (coinAmount <= 0) {
            alert('æ·»åŠ æ•°é‡å¿…é¡»å¤§äº0ï¼');
            return;
        }
        
        if (coinAmount > 100000) {
            alert('å•æ¬¡æ·»åŠ ä¸èƒ½è¶…è¿‡100,000ç”µå¸ï¼');
            return;
        }
        
        const confirmAdd = confirm(`ç¡®è®¤ä¸ºç”¨æˆ· "${username}" æ·»åŠ  ${coinAmount} ç”µå¸ï¼Ÿ`);
        
        if (!confirmAdd) return;
        
        btn.disabled = true;
        btn.textContent = 'æ·»åŠ ä¸­...';
        
        fetch('/api/admin/add-electric-coin', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRF-Token': '<%= csrfToken %>'
            },
            body: JSON.stringify({ username, amount: coinAmount })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert('æ·»åŠ å¤±è´¥: ' + data.message);
                return;
            }
            
            alert(`âœ… æˆåŠŸä¸ºç”¨æˆ· "${username}" æ·»åŠ  ${coinAmount} ç”µå¸ï¼\\næ–°ä½™é¢: ${data.newBalance} ç”µå¸`);
            location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°ä½™é¢
        })
        .catch(err => {
            console.error('Add electric coin error:', err);
            alert('æ·»åŠ è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'âš¡ åŠ ç”µå¸';
        });
    }

    function authorizeUser(username, btn) {
        btn.disabled = true;
        fetch('/api/admin/authorize-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) return alert('æˆæƒå¤±è´¥: ' + data.message);
            location.reload();
        })
        .catch(() => alert('æˆæƒè¯·æ±‚å¤±è´¥'));
    }

    function unauthorizeUser(username, btn) {
        btn.disabled = true;
        fetch('/api/admin/unauthorize-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) return alert('å–æ¶ˆå¤±è´¥: ' + data.message);
            location.reload();
        })
        .catch(() => alert('å–æ¶ˆè¯·æ±‚å¤±è´¥'));
    }

    function resetPassword(username, btn) {
        const confirmReset = confirm('ç¡®å®šè¦é‡ç½®ç”¨æˆ· "' + username + '" çš„å¯†ç å—ï¼Ÿ\\n\\næ–°å¯†ç å°†è®¾ç½®ä¸º: 123456');
        
        if (!confirmReset) return;
        
        const doubleConfirm = confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\\n\\nç”¨æˆ·: ' + username + '\\næ–°å¯†ç : 123456\\n\\nç¡®å®šç»§ç»­å—ï¼Ÿ');
        
        if (!doubleConfirm) return;
        
        btn.disabled = true;
        btn.textContent = 'é‡ç½®ä¸­...';
        
        fetch('/api/admin/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                username: username,
                newPassword: '123456'
            })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert('é‡ç½®å¤±è´¥: ' + data.message);
                return;
            }
            
            alert('âœ… å¯†ç é‡ç½®æˆåŠŸï¼\\n\\nç”¨æˆ·: ' + username + '\\næ–°å¯†ç : 123456\\n\\nè¯·é€šçŸ¥ç”¨æˆ·å°½å¿«ç™»å½•å¹¶ä¿®æ”¹å¯†ç ï¼');
        })
        .catch(err => {
            console.error('Reset password error:', err);
            alert('é‡ç½®è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'ğŸ”‘ é‡ç½®å¯†ç ';
        });
    }

    function deleteAccount(username, btn) {
        const confirmDelete = confirm('âš ï¸ å±é™©æ“ä½œï¼\\n\\nç¡®å®šè¦æ°¸ä¹…æ³¨é”€ç”¨æˆ· "' + username + '" çš„è´¦å·å—ï¼Ÿ\\n\\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\\n- ç”¨æˆ·è´¦å·ä¿¡æ¯\\n- æ‰€æœ‰æ¸¸æˆè®°å½•\\n- æ— æ³•æ¢å¤ï¼');
        
        if (!confirmDelete) return;
        
        const typeUsername = prompt('è¯·è¾“å…¥è¦åˆ é™¤çš„ç”¨æˆ·åä»¥ç¡®è®¤æ“ä½œï¼š\\n\\nè¾“å…¥ "' + username + '" ç¡®è®¤åˆ é™¤');
        
        if (typeUsername !== username) {
            if (typeUsername !== null) {
                alert('ç”¨æˆ·åä¸åŒ¹é…ï¼Œæ“ä½œå–æ¶ˆï¼');
            }
            return;
        }
        
        const finalConfirm = confirm('ğŸš¨ æœ€åç¡®è®¤ï¼ğŸš¨\\n\\nç”¨æˆ·: ' + username + '\\næ“ä½œ: æ°¸ä¹…åˆ é™¤è´¦å·\\nç»“æœ: æ— æ³•æ¢å¤\\n\\nç¡®å®šæ‰§è¡Œå—ï¼Ÿ');
        
        if (!finalConfirm) return;
        
        btn.disabled = true;
        btn.textContent = 'åˆ é™¤ä¸­...';
        btn.style.background = '#6c757d';
        
        fetch('/api/admin/delete-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                username: username
            })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert('æ³¨é”€å¤±è´¥: ' + data.message);
                return;
            }
            
            alert('âœ… è´¦å·æ³¨é”€æˆåŠŸï¼\\n\\nç”¨æˆ· "' + username + '" åŠå…¶æ‰€æœ‰æ•°æ®å·²æ°¸ä¹…åˆ é™¤ã€‚');
            
            const row = btn.closest('tr');
            row.style.background = '#ffebee';
            row.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                row.remove();
            }, 500);
        })
        .catch(err => {
            console.error('Delete account error:', err);
            alert('æ³¨é”€è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'ğŸ—‘ï¸ æ³¨é”€è´¦å·';
            btn.style.background = '#dc3545';
        });
    }

    function unlockAccount(username, btn) {
        const confirmUnlock = confirm('ç¡®å®šè¦è§£é”ç”¨æˆ· "' + username + '" çš„è´¦å·å—ï¼Ÿ\\n\\nè¿™å°†æ¸…é™¤æ‰€æœ‰ç™»å½•å¤±è´¥è®°å½•ã€‚');
        
        if (!confirmUnlock) return;
        
        btn.disabled = true;
        btn.textContent = 'è§£é”ä¸­...';
        btn.style.background = '#6c757d';
        
        fetch('/api/admin/unlock-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert('è§£é”å¤±è´¥: ' + data.message);
                return;
            }
            
            alert('âœ… è´¦å·è§£é”æˆåŠŸï¼\\n\\nç”¨æˆ· "' + username + '" ç°åœ¨å¯ä»¥æ­£å¸¸ç™»å½•äº†ã€‚');
            location.reload();
        })
        .catch(err => {
            console.error('Unlock account error:', err);
            alert('è§£é”è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'è§£é”';
            btn.style.background = '#ffc107';
        });
    }

    function clearFailures(username, btn) {
        const confirmClear = confirm('ç¡®å®šè¦æ¸…é™¤ç”¨æˆ· "' + username + '" çš„ç™»å½•å¤±è´¥è®°å½•å—ï¼Ÿ');
        
        if (!confirmClear) return;
        
        btn.disabled = true;
        btn.textContent = 'æ¸…é™¤ä¸­...';
        btn.style.background = '#6c757d';
        
        fetch('/api/admin/clear-failures', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: username })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert('æ¸…é™¤å¤±è´¥: ' + data.message);
                return;
            }
            
            alert('âœ… å¤±è´¥è®°å½•æ¸…é™¤æˆåŠŸï¼\\n\\nç”¨æˆ· "' + username + '" çš„ç™»å½•å¤±è´¥è®¡æ•°å·²é‡ç½®ã€‚');
            location.reload();
        })
        .catch(err => {
            console.error('Clear failures error:', err);
            alert('æ¸…é™¤è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'æ¸…é™¤';
            btn.style.background = '#17a2b8';
        });
    }

    function editBalance(username, currentBalance) {
        const newBalance = prompt(`ä¿®æ”¹ç”¨æˆ· "${username}" çš„ç”µå¸ä½™é¢:\\n\\nå½“å‰ä½™é¢: ${currentBalance} ç”µå¸\\n\\nè¯·è¾“å…¥æ–°çš„ç”µå¸æ•°é‡:`, currentBalance);
        
        if (newBalance === null) return; // ç”¨æˆ·å–æ¶ˆ
        
        const balance = parseFloat(newBalance);
        
        if (isNaN(balance)) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—é‡‘é¢ï¼');
            return;
        }
        
        if (balance < 0) {
            alert('ä½™é¢ä¸èƒ½ä¸ºè´Ÿæ•°ï¼');
            return;
        }
        
        const confirmChange = confirm(`ç¡®è®¤ä¿®æ”¹ç”µå¸ä½™é¢ï¼Ÿ\\n\\nç”¨æˆ·: ${username}\\nå½“å‰ä½™é¢: ${currentBalance} ç”µå¸\\næ–°ä½™é¢: ${balance} ç”µå¸`);
        
        if (!confirmChange) return;
        
        // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
        fetch('/api/admin/update-balance', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRF-Token': '<%= csrfToken %>'
            },
            body: JSON.stringify({ username, balance })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(`âœ… ç”¨æˆ· "${username}" çš„ç”µå¸ä½™é¢å·²æˆåŠŸä¿®æ”¹ä¸º ${balance} ç”µå¸`);
                location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°ä½™é¢
            } else {
                alert('ä¿®æ”¹å¤±è´¥: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Update balance error:', err);
            alert('ä¿®æ”¹è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    function changeSelfPassword() {
        const oldPassword = prompt('è¯·è¾“å…¥å½“å‰å¯†ç :');
        
        if (!oldPassword) {
            alert('å¿…é¡»è¾“å…¥å½“å‰å¯†ç ï¼');
            return;
        }
        
        const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç :\\n\\næ³¨æ„: æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½');
        
        if (!newPassword) {
            alert('æ–°å¯†ç ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('æ–°å¯†ç é•¿åº¦è‡³å°‘éœ€è¦6ä½ï¼');
            return;
        }
        
        const confirmPassword = prompt('è¯·å†æ¬¡ç¡®è®¤æ–°å¯†ç :');
        
        if (newPassword !== confirmPassword) {
            alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
            return;
        }
        
        const confirmChange = confirm(`ç¡®è®¤ä¿®æ”¹å¯†ç ï¼Ÿ\\n\\næ—§å¯†ç : ${'*'.repeat(oldPassword.length)}\\næ–°å¯†ç : ${'*'.repeat(newPassword.length)}`);
        
        if (!confirmChange) return;
        
        fetch('/api/admin/change-self-password', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRF-Token': '<%= csrfToken %>'
            },
            body: JSON.stringify({ 
                oldPassword: oldPassword,
                newPassword: newPassword 
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼\\n\\nè¯·ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ã€‚');
                window.location.href = '/logout';
            } else {
                alert('ä¿®æ”¹å¤±è´¥: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Change password error:', err);
            alert('ä¿®æ”¹è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }

    // ==========================================
    // Cookie ç®¡ç†åŠŸèƒ½
    // ==========================================
    
    // æ£€æŸ¥CookieçŠ¶æ€
    async function checkCookieStatus() {
        try {
            showMessage('æ­£åœ¨æ£€æŸ¥CookieçŠ¶æ€...', 'info');
            
            const response = await fetch('/api/bilibili/cookies/status');
            const result = await response.json();
            
            const statusDiv = document.getElementById('cookieStatus');
            const detailsDiv = document.getElementById('cookieDetails');
            
            if (result.success) {
                if (result.expired) {
                    statusDiv.style.background = 'rgba(244, 67, 54, 0.8)';
                    statusDiv.style.color = 'white';
                    statusDiv.innerHTML = 'âŒ Cookieå·²è¿‡æœŸ';
                    
                    let reasonText = '';
                    switch(result.reason) {
                        case 'no_cookies': reasonText = 'æœªæ‰¾åˆ°cookieæ–‡ä»¶'; break;
                        case 'missing_key_cookies': reasonText = 'ç¼ºå°‘å…³é”®cookie'; break;
                        case 'login_required': reasonText = 'éœ€è¦é‡æ–°ç™»å½•'; break;
                        default: reasonText = result.reason || 'æœªçŸ¥åŸå› ';
                    }
                    
                    detailsDiv.innerHTML = `
                        <div style="color: #f44336;">ğŸš¨ CookieçŠ¶æ€: å·²è¿‡æœŸ</div>
                        <div style="margin-top: 0.5rem;">åŸå› : ${reasonText}</div>
                        <div style="margin-top: 0.5rem;">å»ºè®®: ç‚¹å‡»"åˆ·æ–°Cookie"æŒ‰é’®é‡æ–°è·å–</div>
                    `;
                } else {
                    statusDiv.style.background = 'rgba(76, 175, 80, 0.8)';
                    statusDiv.style.color = 'white';
                    statusDiv.innerHTML = 'âœ… Cookieæœ‰æ•ˆ';
                    
                    const lastCheck = new Date(result.lastCheck).toLocaleString('zh-CN');
                    const nextCheck = new Date(result.nextCheck).toLocaleString('zh-CN');
                    
                    detailsDiv.innerHTML = `
                        <div style="color: #4caf50;">âœ… CookieçŠ¶æ€: æœ‰æ•ˆ</div>
                        <div style="margin-top: 0.5rem;">ä¸Šæ¬¡æ£€æŸ¥: ${result.lastCheck ? lastCheck : 'æœªæ£€æŸ¥'}</div>
                        <div style="margin-top: 0.5rem;">ä¸‹æ¬¡æ£€æŸ¥: ${nextCheck}</div>
                        <div style="margin-top: 0.5rem;">æ£€æŸ¥é—´éš”: ${Math.round(result.checkInterval / 60000)} åˆ†é’Ÿ</div>
                    `;
                }
            } else {
                statusDiv.style.background = 'rgba(244, 67, 54, 0.8)';
                statusDiv.style.color = 'white';
                statusDiv.innerHTML = 'âŒ æ£€æŸ¥å¤±è´¥';
                detailsDiv.innerHTML = `<div style="color: #f44336;">é”™è¯¯: ${result.message}</div>`;
            }
            
        } catch (error) {
            console.error('æ£€æŸ¥CookieçŠ¶æ€å¤±è´¥:', error);
            showMessage('æ£€æŸ¥CookieçŠ¶æ€å¤±è´¥: ' + error.message, 'error');
        }
    }

    // åˆ·æ–°Cookie
    async function refreshCookies() {
        try {
            if (!confirm('ç¡®å®šè¦åˆ·æ–°Bç«™Cookieå—ï¼Ÿ\\n\\nè¿™å°†æ‰“å¼€æµè§ˆå™¨çª—å£ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­å®Œæˆç™»å½•æ“ä½œã€‚')) {
                return;
            }
            
            showMessage('æ­£åœ¨åˆ·æ–°Cookieï¼Œè¯·åœ¨å¼¹å‡ºçš„æµè§ˆå™¨ä¸­å®Œæˆç™»å½•...', 'info');
            
            const statusDiv = document.getElementById('cookieStatus');
            statusDiv.style.background = 'rgba(255, 193, 7, 0.8)';
            statusDiv.style.color = 'white';
            statusDiv.innerHTML = 'ğŸ”„ æ­£åœ¨åˆ·æ–°...';
            
            const response = await fetch('/api/bilibili/cookies/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '<%= csrfToken %>'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage('Cookieåˆ·æ–°æˆåŠŸï¼', 'success');
                checkCookieStatus(); // é‡æ–°æ£€æŸ¥çŠ¶æ€
            } else {
                showMessage('Cookieåˆ·æ–°å¤±è´¥: ' + result.message, 'error');
                statusDiv.style.background = 'rgba(244, 67, 54, 0.8)';
                statusDiv.innerHTML = 'âŒ åˆ·æ–°å¤±è´¥';
            }
            
        } catch (error) {
            console.error('åˆ·æ–°Cookieå¤±è´¥:', error);
            showMessage('åˆ·æ–°Cookieå¤±è´¥: ' + error.message, 'error');
        }
    }

    // ==========================================
    // ç›´æ’­é—´ç®¡ç†åŠŸèƒ½
    // ==========================================
    
    // ç»‘å®šç”¨æˆ·æˆ¿é—´
    async function bindUserRoom() {
        try {
            const username = document.getElementById('bindUsername').value.trim();
            const roomId = document.getElementById('bindRoomId').value.trim();
            
            if (!username) {
                showMessage('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            if (!roomId) {
                showMessage('è¯·è¾“å…¥æˆ¿é—´å·', 'error');
                return;
            }
            
            if (!/^\d{6,12}$/.test(roomId)) {
                showMessage('æˆ¿é—´å·æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º6-12ä½æ•°å­—', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦ä¸ºç”¨æˆ· "${username}" ç»‘å®šæˆ¿é—´å· "${roomId}" å—ï¼Ÿ`)) {
                return;
            }
            
            const response = await fetch('/api/bilibili/room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '<%= csrfToken %>'
                },
                body: JSON.stringify({
                    targetUsername: username,
                    roomId: roomId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('bindUsername').value = '';
                document.getElementById('bindRoomId').value = '';
                // åˆ·æ–°ç»‘å®šåˆ—è¡¨
                loadRoomBindings();
            } else {
                showMessage(result.message || 'ç»‘å®šå¤±è´¥', 'error');
            }
            
        } catch (error) {
            console.error('ç»‘å®šæˆ¿é—´å¤±è´¥:', error);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }

    // è§£é™¤ç”¨æˆ·æˆ¿é—´ç»‘å®š
    async function unbindUserRoom() {
        try {
            const username = document.getElementById('unbindUsername').value.trim();
            
            if (!username) {
                showMessage('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦ä¸ºç”¨æˆ· "${username}" è§£é™¤æˆ¿é—´ç»‘å®šå—ï¼Ÿ\\n\\nè§£é™¤åè¯¥ç”¨æˆ·æ— æ³•è‡ªåŠ¨å‘é€ç¤¼ç‰©ã€‚`)) {
                return;
            }
            
            const response = await fetch('/api/bilibili/room', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': '<%= csrfToken %>'
                },
                body: JSON.stringify({
                    targetUsername: username
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('unbindUsername').value = '';
                // åˆ·æ–°ç»‘å®šåˆ—è¡¨
                loadRoomBindings();
            } else {
                showMessage(result.message || 'è§£é™¤ç»‘å®šå¤±è´¥', 'error');
            }
            
        } catch (error) {
            console.error('è§£é™¤ç»‘å®šå¤±è´¥:', error);
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }

    // åŠ è½½æˆ¿é—´ç»‘å®šåˆ—è¡¨
    async function loadRoomBindings() {
        try {
            const response = await fetch('/api/bilibili/room');
            const result = await response.json();
            
            const bindingsDiv = document.getElementById('currentBindings');
            
            if (result.success && result.isAdminView && result.allBindings) {
                if (result.allBindings.length > 0) {
                    bindingsDiv.innerHTML = result.allBindings.map(binding => `
                        <div style="
                            display: flex; justify-content: space-between; align-items: center;
                            padding: 0.8rem; margin-bottom: 0.5rem;
                            background: rgba(76, 175, 80, 0.1); border-radius: 8px;
                            border-left: 4px solid #4caf50;
                        ">
                            <div>
                                <strong style="color: #4caf50;">ğŸ‘¤ ${binding.username}</strong>
                                <span style="margin: 0 1rem; color: #ccc;">â†’</span>
                                <strong style="color: #ff9800;">ğŸ“º ${binding.roomId}</strong>
                            </div>
                            <div style="font-size: 0.8rem; color: #999;">
                                ${new Date(binding.bindTime).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `).join('');
                } else {
                    bindingsDiv.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 2rem;">
                            ğŸ“­ æš‚æ— ç”¨æˆ·ç»‘å®šç›´æ’­é—´
                        </div>
                    `;
                }
            } else {
                bindingsDiv.innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 2rem;">
                        âŒ åŠ è½½ç»‘å®šä¿¡æ¯å¤±è´¥
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('åŠ è½½æˆ¿é—´ç»‘å®šå¤±è´¥:', error);
            const bindingsDiv = document.getElementById('currentBindings');
            bindingsDiv.innerHTML = `
                <div style="text-align: center; color: #f44336; padding: 2rem;">
                    âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½ç»‘å®šä¿¡æ¯
                </div>
            `;
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 8px; color: white; font-weight: bold; z-index: 1001;
            animation: slideIn 0.3s ease; max-width: 400px;
        `;
        
        const colors = {
            success: 'linear-gradient(135deg, #4caf50, #45a049)',
            error: 'linear-gradient(135deg, #f44336, #d32f2f)',
            info: 'linear-gradient(135deg, #2196f3, #1976d2)'
        };
        
        messageDiv.style.background = colors[type] || colors.info;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.remove();
        }, 5000);
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // è‡ªåŠ¨æ£€æŸ¥CookieçŠ¶æ€
        checkCookieStatus();
        // è‡ªåŠ¨åŠ è½½æˆ¿é—´ç»‘å®š
        loadRoomBindings();
    });

    </script>
    
    <style>
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
    }
    </style>
</body>
</html>